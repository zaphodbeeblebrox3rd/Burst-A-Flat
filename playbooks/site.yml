---
- name: Configure Slurm Cluster
  hosts: all
  become: yes
  gather_facts: yes
    
  pre_tasks:
    - name: Update package cache and upgrade packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: yes
        autoremove: yes
      retries: 3
      delay: 90

  roles:
    - role: common
    - role: munge
    - role: slurm

- name: Configure Slurm Controller
  hosts: slurm_controllers
  become: yes
  roles:
    - role: slurm_controller

- name: Configure Slurm Compute Nodes
  hosts: slurm_computes
  become: yes
  roles:
    - role: slurm_compute

- name: Configure NFS Server
  hosts: nfs_servers
  become: yes
  roles:
    - role: nfs_server

- name: Configure Router
  hosts: management-node
  become: yes
  roles:
    - role: router

- name: Configure Network Routes
  hosts: all
  become: yes
  roles:
    - role: network_config

- name: Configure NFS Clients
  hosts: nfs_clients
  become: yes
  roles:
    - role: nfs_client

- name: Configure MariaDB for SlurmDB
  hosts: slurmdb
  become: yes
  roles:
    - role: mariadb_server
    - role: slurmdb

- name: Configure MongoDB Primary
  hosts: mongodb_primary
  become: yes
  roles:
    - role: mongodb_primary

- name: Configure MongoDB Replica
  hosts: mongodb_replica
  become: yes
  roles:
    - role: mongodb_replica

- name: Final cluster configuration
  hosts: all
  become: yes
  tasks:
    - name: Start and enable Slurm services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: "{{ slurm_services }}"
      vars:
        slurm_services: >-
          {%- if inventory_hostname in groups['slurm_controllers'] -%}
            {{ ['munge', 'slurmd', 'slurmctld'] }}
          {%- elif inventory_hostname in groups['slurm_computes'] -%}
            {{ ['munge', 'slurmd'] }}
          {%- else -%}
            {{ [] }}
          {%- endif -%}
      when: slurm_services | length > 0

    - name: Create shared home directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'
      loop:
        - /home/vagrant/shared
        - /home/vagrant/shared/data
        - /home/vagrant/shared/scripts
        - /home/vagrant/shared/results
      when: inventory_hostname in groups['nfs_servers']

    - name: Set up SSH keys for passwordless access
      ansible.builtin.authorized_key:
        user: vagrant
        key: "{{ ssh_public_key }}"
        state: present
      vars:
        ssh_public_key: >-
          {%- if lookup('file', '~/.ssh/id_ed25519.pub', errors='ignore') != '' -%}
            {{ lookup('file', '~/.ssh/id_ed25519.pub') }}
          {%- elif lookup('file', '~/.ssh/id_rsa.pub', errors='ignore') != '' -%}
            {{ lookup('file', '~/.ssh/id_rsa.pub') }}
          {%- else -%}
            ''
          {%- endif -%}
      when: ssh_public_key != ''

    - name: Display cluster information
      ansible.builtin.debug:
        msg: |
          Cluster setup complete!
          Login to the cluster: vagrant ssh login-node
          Check cluster status: sinfo
          Submit a job: sbatch /home/vagrant/shared/scripts/r_workload_demo.sh
